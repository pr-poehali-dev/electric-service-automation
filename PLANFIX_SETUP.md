# Инструкция по настройке интеграции с Планфикс

## Шаг 1: Создание API ключа в Планфикс

1. **Войдите в Планфикс** под учётной записью администратора
   - Откройте ваш аккаунт: https://konigkomfort.planfix.ru

2. **Перейдите в настройки API**
   - Нажмите на **⚙️ (Настройки)** в правом верхнем углу
   - Выберите **API** в левом меню
   - Или сразу перейдите: https://konigkomfort.planfix.ru/account/api/

3. **Создайте новый API ключ**
   - Нажмите кнопку **"Создать ключ"** или **"Добавить ключ"**
   - Введите название: `Интеграция с сайтом` (или любое другое)
   
4. **Настройте права доступа для ключа**
   
   ⚠️ **КРИТИЧЕСКИ ВАЖНО:** Обязательно включите следующие права:
   
   - ✅ **Задачи (Tasks)**
     - `task.create` - Создание задач
     - `task.get` - Чтение задач
     - `task.update` - Обновление задач
   
   - ✅ **Проекты (Projects)** (если нужно)
     - `project.get` - Чтение проектов
   
   - ✅ **Контакты (Contacts)** (опционально)
     - `contact.get` - Чтение контактов
     - `contact.create` - Создание контактов

5. **Сохраните API ключ**
   - Нажмите **"Создать"** или **"Сохранить"**
   - ⚠️ **ВАЖНО:** Скопируйте и сохраните API ключ! Он показывается только один раз!
   - Ключ выглядит примерно так: `a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6`

## Шаг 2: Настройка секретов в проекте poehali.dev

1. **Откройте настройки проекта**
   - Перейдите в раздел **Секреты** (Secrets)

2. **Проверьте существующие секреты**
   
   Должны быть два секрета:
   
   - `PLANFIX_API_KEY`
   - `PLANFIX_ACCOUNT`

3. **Обновите значения секретов**

   ### PLANFIX_API_KEY
   - Значение: вставьте API ключ, который скопировали из Планфикса
   - Пример: `a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6`
   
   ### PLANFIX_ACCOUNT
   - Значение: название вашего аккаунта БЕЗ `.planfix.ru`
   - Пример: `konigkomfort` (НЕ `konigkomfort.planfix.ru`)

## Шаг 3: Тестирование интеграции

1. **Откройте страницу "Поиск заказов"** в админ-панели
   - URL: https://electric-service-automation.poehali.dev/all-orders
   - Войдите как администратор

2. **Нажмите кнопку "Создать тестовую заявку для Планфикс"**
   - Она находится внизу страницы (видна только админам)
   - После нажатия появится уведомление об успехе или ошибке

3. **Проверьте Планфикс**
   - Откройте Планфикс: https://konigkomfort.planfix.ru
   - Перейдите в раздел **Задачи**
   - Должна появиться новая задача: **"Заявка #TEST-... - Тестовый клиент"**

## Шаг 4: Проверка автоматической синхронизации

После настройки все новые заявки будут автоматически отправляться в Планфикс:

1. Клиент создаёт заявку на сайте
2. Система автоматически создаёт задачу в Планфиксе
3. В задаче указываются все детали заявки

## Возможные ошибки и их решение

### ❌ "PLANFIX_API_KEY не установлен"
**Решение:** Добавьте секрет PLANFIX_API_KEY в настройках проекта

### ❌ "PLANFIX_ACCOUNT не установлен"
**Решение:** Добавьте секрет PLANFIX_ACCOUNT в настройках проекта

### ❌ "Scope denied, method not allowed"
**Решение:** API ключ не имеет права на создание задач
- Вернитесь в Планфикс → Настройки → API
- Отредактируйте ключ
- Убедитесь что включено право `task.create`
- Сохраните изменения

### ❌ "Unauthorized" или "Invalid token"
**Решение:** API ключ неверный или устарел
- Создайте новый API ключ в Планфиксе
- Обновите секрет PLANFIX_API_KEY

### ❌ "Template not found"
**Решение:** Проект с ID=1 не существует
- В Планфиксе создайте проект для заявок
- Или измените код функции, указав правильный ID проекта

## Структура задачи в Планфиксе

Каждая заявка создаёт задачу со следующей информацией:

```
Название: Заявка #ORD-1234567890 - Иван Иванов

Описание:
Заявка #ORD-1234567890

Клиент: Иван Иванов
Телефон: +79991234567
Адрес: г. Калининград, ул. Тестовая, д. 1
Дата визита: 2025-11-06 в 10:00

Услуги:
• Установка розетки x2 - 500₽
• Установка выключателя x3 - 400₽
• Прокладка кабеля x30 - 100₽

Сумма: 5000₽
Статус: pending
```

## Шаг 5: Настройка двусторонней синхронизации (Webhook)

Webhook позволяет автоматически обновлять статус заявок на сайте, когда они меняются в Планфиксе.

### Настройка webhook в Планфиксе

1. **Откройте настройки webhooks**
   - Перейдите: Настройки → API → Webhooks
   - Или: https://konigkomfort.planfix.ru/account/api/webhooks

2. **Создайте новый webhook**
   - Нажмите **"Добавить webhook"**
   - Название: `Синхронизация заявок с сайтом`
   
3. **Настройте параметры**
   
   **URL webhook:**
   ```
   https://functions.poehali.dev/fa59900f-ff39-40ef-99de-7d268159765e?webhook=true
   ```
   
   **События для отслеживания:**
   - ✅ Задача создана (`task.created`)
   - ✅ Задача обновлена (`task.updated`)
   - ✅ Статус задачи изменён (`task.status.changed`)
   
   **Фильтр (опционально):**
   - Отслеживать только задачи из определённого проекта
   - Или задачи, содержащие в названии "Заявка #"

4. **Сохраните webhook**
   - Нажмите **"Создать"** или **"Сохранить"**
   - Планфикс начнёт отправлять уведомления об изменениях

### Как работает синхронизация

**Сайт → Планфикс:**
- Клиент создаёт заявку на сайте
- Автоматически создаётся задача в Планфиксе
- В задаче указываются все детали заявки

**Планфикс → Сайт:**
- Менеджер меняет статус задачи в Планфиксе
- Webhook автоматически обновляет статус заявки на сайте
- ⚠️ **Примечание:** Пока заявки хранятся в localStorage браузера, синхронизация статусов работает только после переноса заявок в базу данных

### Соответствие статусов

| Статус в Планфиксе | Статус на сайте |
|-------------------|----------------|
| Новая / Новое | pending |
| Принято / Подтверждено | confirmed |
| В работе / Выполняется | in-progress |
| Завершена / Выполнена / Закрыта | completed |

## Поддержка

Если возникли проблемы:
1. Проверьте логи функции в poehali.dev
2. Убедитесь что API ключ активен в Планфиксе
3. Проверьте что секреты правильно установлены
4. Используйте тестовую кнопку для проверки интеграции
5. Проверьте что webhook активен в Планфиксе

## Дополнительные возможности

### Тестирование webhook

Вы можете протестировать webhook вручную, отправив POST запрос:

```bash
curl -X POST 'https://functions.poehali.dev/fa59900f-ff39-40ef-99de-7d268159765e?webhook=true' \
  -H 'Content-Type: application/json' \
  -d '{
    "event": "task.updated",
    "task": {
      "id": 12345,
      "title": "Заявка #ORD-1234567890 - Иван Иванов",
      "status": {
        "name": "В работе"
      }
    }
  }'
```

---

**Последнее обновление:** 2025-11-06
**Версия функции:** 2.0 (с поддержкой webhook)